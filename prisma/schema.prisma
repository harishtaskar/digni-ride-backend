// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(uuid())
  name          String?
  phone         String   @unique
  city          String?
  vehicleNumber String?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  ridesCreated     Ride[]        @relation("RidesCreated")
  rideRequests     RideRequest[]
  ridesJoined      Ride[]        @relation("RidesJoined")
  feedbackGiven    Feedback[]    @relation("FeedbackGiven")
  feedbackReceived Feedback[]    @relation("FeedbackReceived")
  addresses        Address[]

  @@index([city])
  @@index([phone])
}

model Ride {
  id            String     @id @default(uuid())
  riderId       String
  passengerId   String?
  startLocation Json
  endLocation   Json
  departureTime DateTime
  note          String?
  status        RideStatus @default(OPEN)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  rider     User          @relation("RidesCreated", fields: [riderId], references: [id])
  passenger User?         @relation("RidesJoined", fields: [passengerId], references: [id])
  requests  RideRequest[]
  feedback  Feedback[]

  @@index([status])
  @@index([departureTime])
  @@index([riderId])
  @@index([passengerId])
}

model RideRequest {
  id          String            @id @default(uuid())
  rideId      String
  passengerId String
  note        String?
  status      RideRequestStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  ride      Ride @relation(fields: [rideId], references: [id], onDelete: Cascade)
  passenger User @relation(fields: [passengerId], references: [id])

  @@unique([rideId, passengerId])
  @@index([rideId])
  @@index([passengerId])
  @@index([status])
}

model Feedback {
  id         String   @id @default(uuid())
  rideId     String
  fromUserId String
  toUserId   String
  userRole   UserRole
  rating     Int
  comment    String?

  createdAt DateTime @default(now())

  // Relations
  ride     Ride @relation(fields: [rideId], references: [id], onDelete: Cascade)
  fromUser User @relation("FeedbackGiven", fields: [fromUserId], references: [id])
  toUser   User @relation("FeedbackReceived", fields: [toUserId], references: [id])

  @@unique([rideId, fromUserId])
  @@index([toUserId])
  @@index([rideId])
}

enum RideStatus {
  OPEN
  MATCHED
  COMPLETED
}

enum RideRequestStatus {
  PENDING
  ACCEPTED
  REJECTED
}


enum UserRole {
  RIDER
  PASSENGER
}

model Otp {
  id        String   @id @default(uuid())
  phone     String   @unique
  code      String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([phone])
}

model TokenBlacklist {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
}

model Address {
  id        String   @id @default(uuid())
  userId    String
  title     String
  address   Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}
